---
title: "Saga Software"
date: today
author: "Thomas Haverkamp, Eve Fiskebeck, \nKarin Lagesen, Novicha Nakov"
institute: "NVI"
format: 
  revealjs: 
    embed-resources: true
    logo: "./img/logo.png"
    slide-number: c/t
    incremental: false
    title-slide-attributes: 
      data-background-image: "./img/front_page.png"
      data-background-size: "50%"
      data-background-position: "50% 95%"
execute: 
  cache: false
editor: 
  markdown: 
    wrap: 72
---

## Softwares in SAGA:

-   Modules

-   Conda

-   Containers


# Modules

- Allows coexistence different sofware versions available - without bad interaction

- loading module = making available = findable and therefore usable in your $PATH

- SAGA people have installed those, not us. Possible to ask installation (if benefit also external people)

- All dependencies of each software should have been installed in the software module


[Saga documentation on modules](https://documentation.sigma2.no/software/modulescheme.html#module-scheme)


## What modules are installed ?

```{.bash}
module avail 
module avail | less  # allows searching
#: /R/4
```

```{.bash}
R/4.1.2-foss-2021b
R/4.2.1-foss-2022a
R/4.2.2-foss-2022b
R/4.3.2-gfbf-2023a
R/4.3.3-gfbf-2023b
```

## which module to choose ?

`what/version-compiler-when`

@george explanations : 
<!-- how to choose same software version different compiles 
seems version and compilers used are more homogenous than before
--> 

- foss
- GCCcore
- gompi
- gfbf
- intel-compilers

> "modules created with different toolchains are often incompatible." 

<!-- citat from here 
https://training.pages.sigma2.no/tutorials/hpc-intro/episodes/14-modules.html#
-->

## Using modules 

<is what you write>

```{.bash}
# modules currently loaded
module list
# modules available
module avail <module_name> # module name optional if you know
# making module usables for you
module load <full_name>
```

<!-- examples
module avail java 
--> 

`sticky` - module that is usually not unloaded

## Avoiding interactions / changing version

Situation: eg. interactive jobs, you are testing different things

- avoid interaction between modules : unload / purge modules before using other one


```{.bash}
module purge 
module unload <module_name>
```

> SAGA recomendation: all your slurm scripts should start with `module purge`

You want to try a different version of the module 
- somethimes a version does not work (dont ask me why!)

```{.bash}
module switch <current_module> <new_module>
```

## Usefull tricks

as usuall ...
```{.bash}
module -h # all the module commands 
module keyword bio | less # provide descriptions 
```

## Recommendations 

[Sigma2 training pages](https://training.pages.sigma2.no/tutorials/hpc-intro/episodes/14-modules.html#)

NB: link to [SIGMA2 training material pages](https://documentation.sigma2.no/training/material.html)
<!-- the rest is sure informative also ! --> 

- understand $PATH 

`$PATH="default_path"` -> module load xx -> $PATH="xx_path:default_path"

<!-- 
PATH and which <software>
More detail info & exercises on the training page
--> 

- Path also what happens when using Conda ...

# Conda

> Check first if the software you need is available in modules ! 

Check: [What is conda and Setup](https://nvi-documentation.readthedocs.io/en/latest/tools/setting_up_conda.html)


Available in modules BUT for project nn9305k, we have our own installation 
and setup. 

**Remember you MUST have setup conda correctly before using it**, see
[Setting up conda](https://nvi-documentation.readthedocs.io/en/latest/tools/setting_up_conda.html#setting-up-conda-on-your-login-node)


## Using Conda - basics summary 


```{.bash}
miniconda # activate conda - base (is the default environment)


conda env list # give the list of software installed in conda
# Note the path of environemnts is provided ! 

conda activate <envname>  # "load" put first into PATH the environement
conda list # provide the list of software in the activated environment

conda deactivate # "unload" 
```

##  Sharing environemnts / reproducibility

As mentionned here: 

### HERE 
 
/cluster/projects/nn9305k/src/miniconda/yaml_files


## Using Conda in slurm scripts 

- you might need to provide the path of software, in the Conda environment

```{.bash}
# ex: /cluster/projects/nn9305k/src/miniconda/envs/kraken2

```



## Installation of software with Conda on SAGA (nn9305k project)


See instructions: [Installing software using conda](
https://nvi-documentation.readthedocs.io/en/latest/tools/installing_software_using_conda.html
)

Recommendations : look at [conda documentation](https://docs.conda.io/en/latest/)


# Containers


## What is a container ?

-   Bundle: software, libraries and dependencies in an OS

-   Different types containers (apptainer, docker, singularity, ...)[^1]

> An introduction on containers 
> [BioContainers](https://biocontainers-edu.readthedocs.io/en/latest/)


[^1]: Some compatibility


## Where to find containers

-   Tool own image link, Eg. [BUSCO](https://busco.ezlab.org/) provide
    Docker containers
-   [Biocontainers](https://quay.io/repository/biocontainers) - Community[^2]
-   [Docker Hub](https://hub.docker.com/), Eg. account of "unknown
    people" [^3]

::: aside
(By order of preference)
:::


[^2]: Community that builds containers <https://biocontainers.pro/> With
their [github repository](https://github.com/BioContainers/containers)
where you can find the recipies for building

[^3]: [Like me](https://hub.docker.com/search?q=evezeyl); Not necessary
    all functional nor secure...

# `.bashrc` configuration for easy container usage

## cache / storage location of images

::: {.notes}
-  Some configuration to avoid having to specify options every time you run
a container (makes it much easier to use containers)
:::

lines to add to  `~/.bashrc`

```{.bash}
export APPTAINER_CACHEDIR=${USERWORK}/images

export NXF_APPTAINER_CACHEDIR=${USERWORK}/images
export NXF_APPTAINER_LIBRARYDIR=${USERWORK}/images
```


::: {.notes}
-  Defines where to cache and store containers on SAGA (some variables
   specific for Nextflow container usage: `NFX_`)
:::

## Defines mounting/binding directories  

::: {.notes}
- Directories you bind/mount become accessible when you use the container    

- You can bind a specific directory on SAGA to a specific directory path
mounted in on the container. This can be useful if some software require
a particular organisation of directories and subdirectories (happens
sometimes).

- The most simple it to use the configuration in `.bashrc` or not
specifying the path inside the container, in which case the mounting
path is the same as the one on SAGA, avoiding the need of conversion of
paths.

::: 

```{.bash}
export NXF_APPTAINER_HOME_MOUNT=true
export APPTAINER_BIND="$USERWORK,/cluster/projects/nn9305k/active/<username>,/cluster/projects/nn9305k/db_flatfiles"
```


# How to use containers in SAGA?

> Apptainer

## Pull a container (build image)

Login node (require internet access in this case)

```{.bash}
apptainer pull busco.sif docker://ezlabgva/busco:v5.7.1_cv1
```


## Interactively 

  - Ask interactive resources
  
  - Set an environment variable referring to the path of your image and run.

```{.bash} 
IMG="/cluster/work/users/evezeyl/images/busco.sif"
apptainer shell $IMG
```


Note the prompt !

- A simple test example of usage:

```{.bash}     
ls
busco --list-datasets > 2024-04-29_list_datasets_busco.txt
```

## Mounting custom paths

:::: {.columns}
::: {.column width="60%"}

- full path starting from root

```{.bash}
apptainer exec --bind </saga_path>:</container_path> my_container.sif <command>
```
::: aside
[Complete info on click!](https://apptainer.org/docs/user/main/bind_paths_and_mounts.html)
:::

:::

::: {.column width="40%"}
![bind paths](./img/2024-05-14_10.28.18.excalidraw.png)
::: 
:::



## In a Slurm script 

::: {.notes}
add `apptainer exec $IMG` before the command you want to run
::: 

simple syntax
``` bash
apptainer exec $IMG  <command>
```

example:

``` bash
IMG="/cluster/work/users/evezeyl/images/masurca.sif"
apptainer exec $IMG  masurca -t 4 -i ${R1},${R2} -r ${long_read}  2>&1 | tee masurca_test.log
```

## Build own containers ? 

- A recipe for building is written in a file (def file)

! can be time consuming (first search if already existing)

::: aside
[apptainer documentation](https://apptainer.org/docs/user/main/cli/apptainer_build.html)
::: 


- Recipe "simple" language - compatibility different container systems 
(docker -> apptainer)

::: {.notes}
An example of what I do: (on a linux machine not on SAGA) -
Compatibility - docker (non root) - recipe - push to docker hub - pull
with apptainer

PS: not advanced but working when nothing is already made

- does not have to be docker but is often build in docker - more examples, 
and compatibility transformation to singularity, apptainer osv...

- From Saga -> apptainer (cannot build docker)
- Other systems - your choice ...
:::


## some Advantages / disadvantages of containers

-   full reproducibility (OS + software and dependencies)
-   No update (both good and bad ...if you want latest)
-   Takes storage space
-   Easy ? ...

# Ressources

## Tutorials

-  Reproducible Computational Environments Using Containers: Introduction to Docker, A [Carpentries Incubator lesson](https://carpentries-incubator.github.io/docker-introduction/)

## Documentation

-   [Apptainer](https://apptainer.org/)

-   [Docker](https://docs.docker.com/)

-   [Singularity](https://docs.sylabs.io/guides/3.5/user-guide/introduction.html)

```{=html}
<!--  Examples: Based on template 
Novicha: https://github.com/NorwegianVeterinaryInstitute/slides-nvi-data-eng

Quarto: 
- https://quarto.org/docs/presentations/
- https://quarto.org/docs/presentations/revealjs/

! Build did not work when on one-drive synced directory (do not ask me why !)
-->
```
